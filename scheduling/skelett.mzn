% DD1361 Programmeringsparadigm, Labb L3: Redovisningsschemal√§ggning
% Kod-skelett av Per Austrin
%
% L√∂sning av Felix Liljefors
%
%teachers = 2;
%timeslots = 2;

%solutions = 4;
%solution_lab = [1, 1, 2, 2];
%solution_group = [{1,2}, {3,4}, {1,3}, {2,4}];
%
%

include "globals.mzn";

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% V√ÑRDEN SOM DEFINIERAS I DATAFILERNA
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Antal labb-l√∂sningar som ska redovisas
int: solutions;

% Vilken labb som ska redovisas f√∂r varje labb-l√∂sning
array [Solutions] of int: solution_lab;

% Vilken grupp av studenter som gjort varje labb-l√∂sning
array [Solutions] of set of int: solution_group;

% Antal labbhandledare
int: teachers;

% Antal redovisningstider per handledare
int: timeslots;


%%%%%%%%%%%%%%%%%
% HJ√ÑLPVARIABLER
%%%%%%%%%%%%%%%%%

% M√§ngden av alla labb-l√∂sningar som ska redovisas
set of int: Solutions = 1..solutions;

% M√§ngd med samtliga studenter som ska redovisa n√•got
set of int: Students = array_union(solution_group);

% M√§ngd med samtliga labbar som l√∂sts
set of int: Labs = {lab | lab in solution_lab};

% M√§ngden av alla labbhandledare
set of int: Teachers = 1..teachers;

% M√§ngden av alla redovisningstider
set of int: Timeslots = 1..timeslots;

% Hur m√•nga studenter som vill redovisa varje labb
array [Labs] of int: student_lab_count = 
   [sum (sol in Solutions where solution_lab[sol] = l) (card(solution_group[sol])) | l in Labs]; %aggregate sum of: for every lab solution = l, take cardinality of student set to that specific lab solution

% Hur m√•nga redovisningar det borde bli per labb
array [Labs] of int: presentations_per_lab = [student_lab_count[l] div 2 | l in Labs]; % 3 div 2 ger 1?

% Hur m√•nga redovisningar det borde bli totalt
int: presentations = sum(presentations_per_lab);

% M√§ngden av alla redovisningar
set of int: Presentations = 1..presentations;

% Funktion f√∂r att ber√§kna vilken presentation from ska hantera vilken lab
function array[int] of Labs: compute_presentations(set of Labs: labs) =
          if card(labs) == 0 then
             []
          else
             let {
               int: next_lab = min(labs),               
               array[int] of Labs: result = [next_lab | i in 1..presentations_per_lab[next_lab]] ++ 
                                            compute_presentations(labs diff {next_lab})
             } in
             result
          endif;

% F√∂r varje redovisningsgrupp, vilken labb som ska redovisas
array [Presentations] of Labs: presentation_lab = compute_presentations(Labs);



%%%%%%%%%%%%%%%%%%%%
% L√ñSNINGSVARIABLER
%%%%%%%%%%%%%%%%%%%%

% F√∂r varje redovisningsgrupp, vilka studenter som ing√•r i den
array [Presentations] of var set of Students: presentation_group;

% F√∂r varje redovisningsgrupp, vilken handledare som redovisningen √§r f√∂r
array [Presentations] of var Teachers: presentation_teacher;

% F√∂r varje redovisningsgrupp, vilken tid redovisningen √§r
array [Presentations] of var Timeslots: presentation_time;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% VILLKOR F√ñR ATT L√ñSA PROBLEMET H√ÑR
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Varje student ska f√• redovisa exakt de labbar hen l√∂st, och inte beh√∂va redovisa n√•gon labb mer √§n en g√•ng.
%for all students in Students, if 
constraint forall (s in Solutions) 
 
% Redovisningsgrupperna ska best√• av grupper om 2 studenter (i undantagsfall en grupp per labb med 3 studenter, om det √§r ett udda antal studenter som gjort den labben).
constraint forall (pg in presentation_group) ( card(pg) == 2 \/ card(pg) == 3);

% Varje student ska redovisa varje labb tillsammans med en annan student (eller tv√• andra, i undantagsfallet med en redovisningsgrupp av storlek 3) √§n den/de studenter som hen gjort labben tillsammans med.
%for every presentation group, for every lab group if x is in persentation group and lab group, and y is in lab group, then y is not in presentation group
constraint
    forall (pg in presentation_group) (
        forall (sg in solution_group ) (
            (s1 in sg /\ s2 in sg) -> not(s1 in pg /\ s2 in pg)
        )
    ); 
        
% En labbhandledare kan inte vara inbokad p√• tv√• olika redovisningar vid samma tidpunkt.
% En student kan inte vara inbokad p√• tv√• olika redovisningar vid samma tidpunkt.
% ...


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% S√ñKSPECIFIKATION F√ñR ATT L√ñSA PROBLEMET
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Man kan om man vill speca s√∂kningen mer detaljerat, t.ex. vilken
% s√∂kstrategi som ska anv√§ndas.
solve satisfy;

%%%%%%%%%%%%%%%%%%%%%%
% UTSKRIFT AV L√ñSNING
%%%%%%%%%%%%%%%%%%%%%%

output
 [show(presentations), " redovisningar:\n",
	"    Tid  Handl.  Labb  Studenter\n"] ++
 [ show_int(2, p) ++ ": " ++
   show_int(-3, presentation_time[p]) ++ "  " ++
   show_int(-6, presentation_teacher[p]) ++ "  " ++
   show_int(-4, presentation_lab[p]) ++ "  " ++
   show(presentation_group[p]) ++ "\n"
     | p in Presentations ];
